前言                                                                            5
目录                                                                            13
第一部分　走近java            22
第1章　走近java                                                                 23
	1.1　概述                                                                       23
	1.2　java技术体系                                                               24
	1.3　java发展史                                                                 26
	1.4　java虚拟机发展史                                                           30
		1.4.1　sun classic/exact vm                                                     30
		1.4.2　sun hotspot vm                                                           32
		1.4.3　sun mobile-embedded vm/meta-circular vm                                  33
		1.4.4　bea jrockit/ibm j9 vm                                                    34
		1.4.5　azul vm/bea liquid vm                                                    35
		1.4.6　apache harmony/google android dalvik vm                                  35
		1.4.7　microsoft jvm及其他                                                      36
	1.5　展望java技术的未来                                                         37
		1.5.1　模块化                                                                   38
		1.5.2　混合语言                                                                 38
		1.5.3　多核并行                                                                 40
		1.5.4　进一步丰富语法                                                           41
		1.5.5　64位虚拟机                                                               42
	1.6　实战：自己编译jdk                                                          43
		1.6.1　获取jdk源码                                                              43
		1.6.2　系统需求                                                                 45
		1.6.3　构建编译环境                                                             46
		1.6.4　进行编译                                                                 47
		1.6.5　在ide工具中进行源码调试                                                  52
	1.7　本章小结                                                                   56
第二部分　自动内存管理机制 58
第2章　java内存区域与内存溢出异常                                               59
2.1　概述                                                                       59
2.2　运行时数据区域                                                             59
	2.2.1　程序计数器                                                               60
	2.2.2　java虚拟机栈                                                             60
	2.2.3　本地方法栈                                                               61
	2.2.4　java堆                                                                   62
	2.2.5　方法区                                                                   62
	2.2.6　运行时常量池                                                             63
	2.2.7　直接内存                                                                 64
2.3　hotspot虚拟机对象探秘                                                      64
	2.3.1　对象的创建                                                               65
	2.3.2　对象的内存布局                                                           68
	2.3.3　对象的访问定位                                                           69
2.4　实战：outofmemoryerror异常                                                 71
	2.4.1　java堆溢出                                                               72
	2.4.2　虚拟机栈和本地方法栈溢出                                                 74
	2.4.3　方法区和运行时常量池溢出                                                 77
	2.4.4　本机直接内存溢出                                                         80
2.5　本章小结                                                                   81
第3章　垃圾收集器与内存分配策略                                                 82
3.1　概述                                                                       82
3.2　对象已死吗                                                                 83
	3.2.1　引用计数算法                                                             83
	3.2.2　可达性分析算法                                                           85
	3.2.3　再谈引用                                                                 86
	3.2.4　生存还是死亡                                                             87
	3.2.5　回收方法区                                                               89
3.3　垃圾收集算法                                                               90
	3.3.1　标记-清除算法                                                            90
	3.3.2　复制算法                                                                 91
	3.3.3　标记-整理算法                                                            92
	3.3.4　分代收集算法                                                             93
3.4　hotspot的算法实现                                                          93
	3.4.1　枚举根节点                                                               93
	3.4.2　安全点                                                                   94
	3.4.3　安全区域                                                                 95
3.5　垃圾收集器                                                                 96
	3.5.1　serial收集器                                                             97
	3.5.2　parnew收集器                                                             98
	3.5.3　parallel scavenge收集器                                                  100
	3.5.4　serial old收集器                                                         101
	3.5.5　parallel old收集器                                                       101
	3.5.6　cms收集器                                                                102
3.5.7　g1收集器                                                                 105
3.5.8　理解gc日志                                                               110
3.5.9　垃圾收集器参数总结                                                       111
3.6　内存分配与回收策略                                                         112
	3.6.1　对象优先在eden分配                                                       112
	3.6.2　大对象直接进入老年代                                                     114
	3.6.3　长期存活的对象将进入老年代                                               116
	3.6.4　动态对象年龄判定                                                         118
	3.6.5　空间分配担保                                                             119
3.7　本章小结                                                                   121
第4章　虚拟机性能监控与故障处理工具                                             122
4.1　概述                                                                       122
4.2　jdk的命令行工具                                                            122
	4.2.1　jps：虚拟机进程状况工具                                                  125
	4.2.2　jstat：虚拟机统计信息监视工具                                            126
	4.2.3　jinfo：java配置信息工具                                                  127
	4.2.4　jmap：java内存映像工具                                                   128
	4.2.5　jhat：虚拟机堆转储快照分析工具                                           129
	4.2.6　jstack：java堆栈跟踪工具                                                 130
	4.2.7　hsdis：jit生成代码反汇编                                                 132
4.3　jdk的可视化工具                                                            135
	4.3.1　jconsole：java监视与管理控制台                                           136
	4.3.2　visualvm：多合一故障处理工具                                             143
4.4　本章小结                                                                   152
第5章　调优案例分析与实战                                                       153
5.1　概述                                                                       153
5.2　案例分析                                                                   153
	5.2.1　高性能硬件上的程序部署策略                                               153
	5.2.2　集群间同步导致的内存溢出                                                 156
	5.2.3　堆外内存导致的溢出错误                                                   157
	5.2.4　外部命令导致系统缓慢                                                     158
	5.2.5　服务器jvm进程崩溃                                                        159
	5.2.6　不恰当数据结构导致内存占用过大                                           160
	5.2.7　由windows虚拟内存导致的长时间停顿                                        162
5.3　实战：eclipse运行速度调优                                                  163
	5.3.1　调优前的程序运行状态                                                     163
	5.3.2　升级jdk 1.6的性能变化及兼容问题                                          166
	5.3.3　编译时间和类加载时间的优化                                               171
	5.3.4　调整内存设置控制垃圾收集频率                                             174
	5.3.5　选择收集器降低延迟                                                       178
5.4　本章小结                                                                   181
第三部分　虚拟机执行子系统 182
第6章　类文件结构                                                               183
6.1　概述                                                                       183
6.2　无关性的基石                                                               183
6.3　class类文件的结构                                                          185
	6.3.1　魔数与class文件的版本                                                    187
	6.3.2　常量池                                                                   188
	6.3.3　访问标志                                                                 194
	6.3.4　类索引、父类索引与接口索引集合                                           195
	6.3.5　字段表集合                                                               196
	6.3.6　方法表集合                                                               199
	6.3.7　属性表集合                                                               201
6.4　字节码指令简介                                                             217
	6.4.1　字节码与数据类型                                                         218
	6.4.2　加载和存储指令                                                           220
	6.4.3　运算指令                                                                 221
	6.4.4　类型转换指令                                                             223
	6.4.5　对象创建与访问指令                                                       224
	6.4.6　操作数栈管理指令                                                         224
	6.4.7　控制转移指令                                                             225
	6.4.8　方法调用和返回指令                                                       225
	6.4.9　异常处理指令                                                             226
	6.4.10　同步指令                                                                226
6.5　公有设计和私有实现                                                         227
6.6　class文件结构的发展                                                        228
6.7　本章小结                                                                   229
第7章　虚拟机类加载机制                                                         230
7.1　概述                                                                       230
7.2　类加载的时机                                                               231
7.3　类加载的过程                                                               235
	7.3.1　加载                                                                     235
	7.3.2　验证                                                                     237
	7.3.3　准备                                                                     240
	7.3.4　解析                                                                     241
	7.3.5　初始化                                                                   246
7.4　类加载器                                                                   248
	7.4.1　类与类加载器                                                             249
	7.4.2　双亲委派模型                                                             250
	7.4.3　破坏双亲委派模型                                                         254
7.5　本章小结                                                                   256
第8章　虚拟机字节码执行引擎                                                     257
8.1　概述                                                                       257
8.2　运行时栈帧结构                                                             257
	8.2.1　局部变量表                                                               259
	8.2.2　操作数栈                                                                 263
	8.2.3　动态连接                                                                 264
	8.2.4　方法返回地址                                                             264
	8.2.5　附加信息                                                                 265
8.3　方法调用                                                                   265
	8.3.1　解析                                                                     265
	8.3.2　分派                                                                     267
	8.3.3　动态类型语言支持                                                         279
8.4　基于栈的字节码解释执行引擎                                                 290
	8.4.1　解释执行                                                                 290
	8.4.2　基于栈的指令集与基于寄存器的指令集                                       291
	8.4.3　基于栈的解释器执行过程                                                   293
8.5　本章小结                                                                   296
第9章　类加载及执行子系统的案例与实战                                           297
9.1　概述                                                                       297
9.2　案例分析                                                                   297
	9.2.1　tomcat：正统的类加载器架构                                               297
	9.2.2　osgi：灵活的类加载器架构                                                 300
	9.2.3　字节码生成技术与动态代理的实现                                           303
	9.2.4　retrotranslator：跨越jdk版本                                             307
9.3　实战：自己动手实现远程执行功能                                             310
	9.3.1　目标                                                                     311
	9.3.2　思路                                                                     311
	9.3.3　实现                                                                     312
	9.3.4　验证                                                                     319
9.4　本章小结                                                                   320
第四部分　程序编译与代码优化 322
第10章　早期（编译期）优化                                                      323
10.1　概述                                                                      323
10.2　javac编译器                                                               324
	10.2.1　javac的源码与调试                                                       324
	10.2.2　解析与填充符号表                                                        326
	10.2.3　注解处理器                                                              328
	10.2.4　语义分析与字节码生成                                                    328
10.3　java语法糖的味道                                                          332
	10.3.1　泛型与类型擦除                                                          332
	10.3.2　自动装箱、拆箱与遍历循环                                                336
	10.3.3　条件编译                                                                338
10.4　实战：插入式注解处理器                                                    339
	10.4.1　实战目标                                                                339
	10.4.2　代码实现                                                                340
	10.4.3　运行与测试                                                              347
	10.4.4　其他应用案例                                                            348
10.5　本章小结                                                                  349
第11章　晚期（运行期）优化                                                      350
11.1　概述                                                                      350
11.2　hotspot虚拟机内的即时编译器                                               350
	11.2.1　解释器与编译器                                                          351
	11.2.2　编译对象与触发条件                                                      353
	11.2.3　编译过程                                                                358
	11.2.4　查看及分析即时编译结果                                                  360
11.3　编译优化技术                                                              366
	11.3.1　优化技术概览                                                            367
	11.3.2　公共子表达式消除                                                        371
	11.3.3　数组边界检查消除                                                        372
	11.3.4　方法内联                                                                373
	11.3.5　逃逸分析                                                                375
11.4　java与c/c++的编译器对比                                                   377
11.5　本章小结                                                                  379
第五部分　高效并发 380
第12章　java内存模型与线程                                                      381
12.1　概述                                                                      381
12.2　硬件的效率与一致性                                                        382
12.3　java内存模型                                                              383
	12.3.1　主内存与工作内存                                                        384
	12.3.2　内存间交互操作                                                          385
	12.3.3　对于volatile型变量的特殊规则                                            387
	12.3.4　对于long和double型变量的特殊规则                                        393
	12.3.5　原子性、可见性与有序性                                                  394
	12.3.6　先行发生原则                                                            396
12.4　java与线程                                                                399
	12.4.1　线程的实现                                                              399
	12.4.2　java线程调度                                                            402
	12.4.3　状态转换                                                                404
12.5　本章小结                                                                  405
第13章　线程安全与锁优化                                                        406
13.1　概述                                                                      406
13.2　线程安全                                                                  406
	13.2.1　java语言中的线程安全                                                    407
	13.2.2　线程安全的实现方法                                                      411
13.3　锁优化                                                                    418
	13.3.1　自旋锁与自适应自旋                                                      419
	13.3.2　锁消除                                                                  419
	13.3.3　锁粗化                                                                  421
	13.3.4　轻量级锁                                                                421
	13.3.5　偏向锁                                                                  423
13.4　本章小结                                                                  424
附 录 426
0.0 附录a　编译windows版的openjdk	427
0.0 附录b　虚拟机字节码指令表	435
0.0 附录c　hotspot虚拟机主要参数表	441
0.0 附录d　对象查询语言（oql）简介	445
0.0 附录e　jdk历史版本轨迹	451

