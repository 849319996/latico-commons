目录	7
前言	4
第一部分 Logstash	14
第1章　入门示例	16
	1.1　下载安装	16
	1.2　Hello World	17
	1.3　配置语法	21
		1.3.1　语法	21
		1.3.2　命令行参数	23
		1.3.3　设置文件示例	24
	1.4　插件安装	25
	1.5　长期运行方式	26
第2章　插件配置	28
	2.1　输入插件	28
		2.1.1　标准输入	29
		2.1.2　文件输入	30
		2.1.3　TCP输入	31
		2.1.4　syslog输入	32
		2.1.5　http_poller抓取	34
	2.2　编解码配置	35
		2.2.1　JSON编解码	36
		2.2.2　多行事件编码	37
		2.2.3　网络流编码	39
		2.2.4　collectd输入	40
	2.3　过滤器配置	43
		2.3.1　date时间处理	43
		2.3.2　grok正则捕获	46
		2.3.3　dissect解析	48
		2.3.4　GeoIP地址查询	49
		2.3.5　JSON编解码	51
		2.3.6　key-value切分	51
		2.3.7　metrics数值统计	53
		2.3.8　mutate数据修改	54
		2.3.9　随心所欲的Ruby处理	58
		2.3.10　split拆分事件	60
		2.3.11　交叉日志合并	61
	2.4　输出插件	62
		2.4.1　输出到Elasticsearch	62
		2.4.2　发送email	67
		2.4.3　调用系统命令执行	67
		2.4.4　保存成文件	68
		2.4.5　报警发送到Nagios	69
		2.4.6　statsd	71
		2.4.7　标准输出stdout	74
		2.4.8　TCP发送数据	75
		2.4.9　输出到HDFS	75
第3章　场景示例	77
	3.1　Nginx访问日志	77
		3.1.1　grok处理方式	77
		3.1.2　split处理方式	78
		3.1.3　JSON格式	81
		3.1.4　syslog方式发送	82
	3.2　Nginx错误日志	82
	3.3　Postfix日志	84
	3.4　Ossec日志	85
		3.4.1　配置所有Ossec agent采用syslog输出	85
		3.4.2　配置Logstash	85
		3.4.3　推荐Kibana仪表盘	86
	3.5　Windows系统日志	86
		3.5.1　采集端配置	86
		3.5.2　接收解析端配置	88
	3.6　Java日志	90
		3.6.1　Log4J配置	90
		3.6.2　Logstash配置	91
		3.6.3　异常堆栈测试验证	91
		3.6.4　JSON Event layout	92
	3.7　MySQL慢查询日志	93
	3.8　Docker日志	95
		3.8.1　记录到主机磁盘	95
		3.8.2　通过logspout收集	96
第4章　性能与监控	98
	4.1　性能测试	98
		4.1.1　配置示例	98
		4.1.2　使用方式	99
		4.1.3　额外的话	100
	4.2　监控方案	100
		4.2.1　logstash-input-heartbeat心跳检测方式	101
		4.2.2　JMX启动参数方式	102
		4.2.3　API方式	103
第5章　扩展方案	107
	5.1　通过Redis队列扩展	108
		5.1.1　读取Redis数据	108
		5.1.2　采用list类型扩展Logstash	109
		5.1.3　输出到Redis	110
	5.2　通过Kafka队列扩展	111
		5.2.1　Kafka基础概念	112
		5.2.2　Input配置	113
		5.2.3　Output配置	114
		5.2.4　性能	116
	5.3　logstash-forwarder	116
		5.3.1　Indexer端配置	117
		5.3.2　Shipper端配置	117
		5.3.3　AIX上的logstash-forwarder-java	119
	5.4　Rsyslog	120
		5.4.1　常用模块介绍	120
		5.4.2　与Logstash合作	122
		5.4.3　Mmexternal模块	122
	5.5　Nxlog	125
	5.6　Heka	127
	5.7　Fluentd	128
		5.7.1　配置示例	128
		5.7.2　Fluentd插件	130
	5.8　Message::Passing	130
第6章　Logstash源码解析	132
	6.1　Pipeline	133
	6.2　Plugins	135
第7章　插件开发	138
	7.1　插件格式	138
	7.2　插件的关键方法	139
	7.3　插件打包	140
	7.4　Filter插件开发示例	141
		7.4.1　mmdb数据库的生成方法	142
		7.4.2　LogStash::Filters::Mmdb实现	143
		7.4.3　logstash-filter-mmdb打包	144
	7.5　Input插件开发示例	145
		7.5.1　FileWatch模块原理	145
		7.5.2　LogStash::Inputs::Utmp实现	146
	7.6　Output插件开发示例	149
第8章　Beats	151
	8.1　libbeat的通用配置	151
		8.1.1　过滤器配置	151
		8.1.2　输出配置	152
		8.1.3　shipper网络配置	155
		8.1.4　日志配置	155
		8.1.5　运行配置	155
	8.2　Filebeat	155
		8.2.1　安装部署	156
		8.2.2　配置	157
		8.2.3　生成的可用字段	158
	8.3　packetbeat抓包分析	158
		8.3.1　安装部署	159
		8.3.2　配置示例	159
		8.3.3　dashboard效果	160
		8.3.4　Kibana 3拓扑图	161
	8.4　metricbeat	163
		8.4.1　配置示例	165
		8.4.2　各模块输出指标示例	165
		8.4.3　采集Docker中的指标	177
	8.5　winlogbeat	177
第二部分 Elasticsearch	181
第9章　架构原理	182
	9.1　准实时索引的实现	182
		9.1.1　动态更新的Lucene索引	182
		9.1.2　利用磁盘缓存实现的准实时检索	183
		9.1.3　translog提供的磁盘同步控制	184
	9.2　segment merge的影响	185
		9.2.1　归并线程配置	186
		9.2.2　归并策略	187
		9.2.3　forcemerge接口	187
	9.3　routing和replica的读写过程	187
		9.3.1　路由计算	188
		9.3.2　副本一致性	188
	9.4　shard的allocate控制	189
		9.4.1　reroute接口	191
		9.4.2　分配失败原因	192
		9.4.3　节点下线	193
		9.4.4　冷热数据的读写分离	193
	9.5　自动发现的配置	194
第10章　数据接口用例	196
	10.1　增删改查操作	196
	10.2　搜索请求	198
		10.2.1　全文搜索	198
		10.2.2　聚合请求	200
		10.2.3　pipeline聚合	202
		10.2.4　搜索请求参数	204
	10.3　脚本	205
		10.3.1　动态提交	205
		10.3.2　固定文件	206
		10.3.3　其他语言	207
	10.4　重建索引	207
		10.4.1　Perl客户端	207
		10.4.2　用Logstash重建索引	208
		10.4.3　新reindex接口的应用	208
	10.5　Spark Streaming交互	210
第11章　性能优化	212
	11.1　bulk提交	212
		11.1.1　bulk大小	213
		11.1.2　UDP方式	213
	11.2　gateway配置	214
	11.3　集群状态维护	215
	11.4　缓存	219
		11.4.1　filter缓存	219
		11.4.2　shard reguest缓存	220
		11.4.3　field_stats 接口	221
	11.5　字段数据	222
		11.5.1　Circuit Breaker	222
		11.5.2　doc values	223
	11.6　curator工具	225
		11.6.1　参数介绍	226
		11.6.2　常用示例	227
	11.7　profiler调试接口	227
第12章　测试和扩展方案	230
	12.1　测试方案	230
	12.2　多集群互联	233
	12.3　puppet-elasticsearch模块的使用	236
		12.3.1　安装和配置示例	236
		12.3.2　配置解释	237
	12.4　计划内停机升级的操作流程	237
	12.5　Shield权限管理	240
		12.5.1　Shield架构	240
		12.5.2　安装部署	240
	12.6　searchguard权限管理	242
		12.6.1　安装	242
		12.6.2　权限角色配置	244
		12.6.3　其他组件配置方式	246
	12.7　别名的应用	247
		12.7.1　索引更名时的无缝切换	247
		12.7.2　限制索引数据部分可读	249
	12.8　快照与恢复	250
		12.8.1　HDFS插件安装配置	250
		12.8.2　Hadoop配置	251
		12.8.3　备份操作	253
	12.9　rollover和shrink管理	253
		12.9.1　rollover管理	253
		12.9.2　shrink缩容	254
	12.10　ingest节点	256
		12.10.1　创建管道流	256
		12.10.2　测试管道流	256
		12.10.3　处理器	257
第13章　映射与模板的定制	259
	13.1　映射的增删改查	259
	13.2　Elasticsearch的核心类型	261
	13.3　自定义字段映射	262
		13.3.1　精确索引	262
		13.3.2　时间格式	262
		13.3.3　多重索引	263
	13.4　特殊字段	263
	13.5　动态模板映射	264
	13.6　索引模板	265
第14章　监 控 方 案	267
	14.1　监控相关接口	267
		14.1.1　集群健康状态	267
		14.1.2　节点状态	270
		14.1.3　热线程状态	277
		14.1.4　索引状态	278
		14.1.5　任务管理	279
		14.1.6　cat接口的命令行使用	281
	14.2　日志记录	284
	14.3　实时bigdesk方案	285
	14.4　cerebro	287
	14.5　Zabbix trapper方案	288
		14.5.1　安装配置	288
		14.5.2　模板应用	289
第15章　Elasticsearch在运维监控领域的其他应用	291
	15.1　Percolator接口	291
	15.2　Watcher报警	294
	15.3　ElastAlert	297
		15.3.1　安装	297
		15.3.2　配置结构	297
		15.3.3　扩展	299
	15.4　时序数据库	301
	15.5　Etsy的Kale异常检测	303
	15.6　Grafana可视化	304
		15.6.1　安装	304
		15.6.2　配置数据源	305
		15.6.3　生成一个图表	306
		15.6.4　模板功能	308
		15.6.5　在线资源	313
	15.7　Juttle可视化	314
		15.7.1　安装部署	315
		15.7.2　命令行运行示例	315
		15.7.3　可视化界面	317
		15.7.4　可视化相关指令介绍	317
第三部分 Kibana	321
第16章　Kibana的产品对比	322
	16.1　Kibana 3的设计思路和功能	322
	16.2　Kibana 5的设计思路和功能	323
	16.3　与Hadoop体系的区别	323
	16.4　Splunk场景参考	324
第17章　Kibana 5	325
	17.1　安装、配置和运行	326
	17.2　生产环境部署	327
		17.2.1　Nginx代理配置	329
		17.2.2　开启SSL	330
	17.3　Discover功能	331
		17.3.1　设置时间过滤器	331
		17.3.2　搜索数据	332
		17.3.3　按字段过滤	334
		17.3.4　过滤器的协同工作方式	334
		17.3.5　查看文档数据	336
	17.4　各种可视化功能	337
		17.4.1　area	339
		17.4.2　table	342
		17.4.3　line	343
		17.4.4　Markdown	344
		17.4.5　metric	344
		17.4.6　pie	345
		17.4.7　tile map	345
		17.4.8　vertical bar	347
		17.4.9　tagcloud	348
	17.5　仪表盘功能	348
		17.5.1　开始	349
		17.5.2　容器功能	349
		17.5.3　修改可视化	350
		17.5.4　修改主题风格	352
	17.6　management功能	352
		17.6.1　创建一个连接到Elasticsearch的索引模式	352
		17.6.2　字段格式	355
		17.6.3　创建一个脚本化字段	357
		17.6.4　设置高级参数	358
		17.6.5　管理已保存的搜索、可视化和仪表盘	358
	17.7　设置Kibana服务器属性	359
	17.8　常用sub agg示例	360
		17.8.1　函数堆栈链分析	360
		17.8.2　分图统计	362
		17.8.3　TopN的时序趋势图	363
		17.8.4　响应时间的百分占比趋势图	365
		17.8.5　响应时间的概率分布在不同时段的相似度对比	366
	17.9　Kibana报表的快速实现	367
	17.10　timelion应用	368
	17.11　console应用	370
第18章　Kibana 5源码解析	372
	18.1　Kibana索引的数据结构	373
	18.2　主页入口	374
		18.2.1　Kibana App	375
		18.2.2　Courier类	380
		18.2.3　路径记忆功能的实现	383
	18.3　Discover解析	383
	18.4　Visualize解析	387
		18.4.1　vis_types实现	388
		18.4.2　savedVisualizations实现	395
		18.4.3　Visualize实现	395
		18.4.4　VisEditorSidebar实现	396
	18.5　Dashboard解析	397
第19章　Kibana插件开发示例	401
	19.1　Kibana插件	401
		19.1.1　部署命令	401
		19.1.2　默认插件	402
	19.2　可视化插件示例	403
		19.2.1　插件目录生成	403
		19.2.2　主文件及解释	404
	19.3　服务器端插件示例	407
	19.4　完整应用开发示例	411
		19.4.1　App模块的index.js结构	411
		19.4.2　服务器端部分	412
		19.4.3　前台界面的app.js	412
		19.4.4　页面模板	414
