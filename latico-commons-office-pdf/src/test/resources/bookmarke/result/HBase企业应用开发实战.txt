前　言	19
目录	8
第一部分　基础篇	15
第1章　认识HBase	16
	1.1　理解大数据背景	16
		1.1.1　什么是大数据	17
		1.1.2　为何大数据至关重要	18
		1.1.3　NoSQL在大数据中扮演的角色	18
	1.2　HBase是什么	20
		1.2.1　HBase的发展历史	20
		1.2.2　HBase的发行版本	21
		1.2.3　HBase的特性	23
	1.3　HBase与Hadoop的关系	24
	1.4　HBase的核心功能模块	26
		1.4.1　客户端Client	26
		1.4.2　协调服务组件ZooKeeper	27
		1.4.3　主节点HMaster	27
		1.4.4　Region节点HRegionServer	27
	1.5　HBase的使用场景和经典案例	28
		1.5.1　搜索引擎应用	29
		1.5.2　增量数据存储	29
		1.5.3　用户内容服务	31
		1.5.4　实时消息系统构建	32
	1.6　本章小结	32
第2章　HBase安装与配置	33
	2.1　先决条件	33
	2.2　HBase运行模式	37
		2.2.1　单机模式	37
		2.2.2　分布式模式	38
	2.3　HBase的Web UI	45
	2.4　HBase Shell工具使用	45
	2.5　停止HBase集群	47
	2.6　本章小结	47
第3章　数据模型	48
	3.1　两类数据模型	48
		3.1.1　逻辑模型	49
		3.1.2　物理模型	49
	3.2　数据模型的重要概念	50
		3.2.1　表	50
		3.2.2　行键	51
		3.2.3　列族	52
		3.2.4　单元格	52
	3.3　数据模型的操作	52
		3.3.1　读Get	53
		3.3.2　写Put	53
		3.3.3　扫描Scan	53
		3.3.4　删除Delete	54
	3.4　数据模型的特殊属性	54
		3.4.1　版本	54
		3.4.2　排序	56
		3.4.3　列的元数据	56
		3.4.4　连接查询	57
		3.4.5　计数器	57
		3.4.6　原子操作	57
		3.4.7　事务特性ACID	57
		3.4.8　行锁	59
		3.4.9　自动分区	59
	3.5　CAP原理与最终一致性	60
	3.6　本章小结	61
第4章　HBase表结构设计	62
	4.1　模式创建	62
	4.2　Rowkey设计	63
	4.3　列族定义	65
		4.3.1　可配置的数据块大小	65
		4.3.2　数据块缓存	66
		4.3.3　布隆过滤器	66
		4.3.4　数据压缩	67
		4.3.5　单元时间版本	67
		4.3.6　生存时间	68
	4.4　模式设计实例	68
		4.4.1　实例1：动物分类	68
		4.4.2　实例2：店铺与商品	70
		4.4.3　实例3：网上商城用户消费记录	71
		4.4.4　实例4：微博用户与粉丝	72
	4.5　本章小结	74
第5章　HBase客户端	75
	5.1　精通原生Java客户端	75
		5.1.1　客户端配置	76
		5.1.2　创建表	83
		5.1.3　删除表	84
		5.1.4　插入数据	84
		5.1.5　查询数据	86
		5.1.6　删除数据	90
		5.1.7　过滤查询	91
	5.2　使用HBase Shell工具操作HBase	93
		5.2.1　命令分类	93
		5.2.2　常规命令	94
		5.2.3　DDL命令	95
		5.2.4　DML命令	96
		5.2.5　工具命令Tools	100
		5.2.6　复制命令	101
		5.2.7　安全命令	101
	5.3　使用Thrift客户端访问HBase	102
		5.3.1　Thrift与Thrift2区别	102
		5.3.2　安装与部署Thrift2	103
		5.3.3　Python使用案例	107
	5.4　通过REST客户端访问HBase	109
		5.4.1　启动服务	109
		5.4.2　使用REST访问example表	110
	5.5　使用MapReduce批量操作HBase	111
		5.5.1　三种访问模式	112
		5.5.2　实现MapReduce API	112
		5.5.3　HBase作为输入源示例	113
		5.5.4　HBase作为输出源示例	115
		5.5.5　HBase作为共享源示例	117
	5.6　通过Web UI工具查看HBase状态	120
		5.6.1　Master状态界面	120
		5.6.2　RegionServer状态界面	121
		5.6.3　ZooKeeper统计信息页面	123
	5.7　其他客户端	124
	5.8　本章小结	124
第二部分　实战篇	127
第6章　整合SQL引擎层	128
	6.1　NoSQL背景知识	128
		6.1.1　什么是NoSQL	128
		6.1.2　将SQL整合到HBase的原因	129
		6.1.3　基于HBase的SQL引擎实现	130
	6.2　Hive整合HBase的实现	133
		6.2.1　认识Hive	133
		6.2.2　Hive整合HBase的环境准备	136
		6.2.3　Linux环境下重新编译Hive	137
		6.2.4　Hive参数配置	139
		6.2.5　启动Hive	141
		6.2.6　Hive与HBase整合后的框架如何使用	141
		6.2.7　HBase到Hive的字段映射	147
		6.2.8　多列与Hive Map类型	148
	6.3　查询引擎Phoenix	151
		6.3.1　认识Phoenix	152
		6.3.2　Phoenix安装环境准备	155
		6.3.3　Phoenix安装部署	156
		6.3.4　Phoenix源码编译	157
		6.3.5　Phoenix中SQLLine的快速使用	163
		6.3.6　使用JDBC访问Phoenix	167
	6.4　对象映射框架Kundera	169
		6.4.1　认识Kundera	169
		6.4.2　Kundera的客户端API快速使用	172
		6.4.3　Kundera模块介绍	175
		6.4.4　Kundera的REST访问方式	176
	6.5　分布式SQL引擎Lealone	179
		6.5.1　认识Lealone	179
		6.5.2　Lealone的安装部署	180
		6.5.3　通过JDBC访问Lealone	182
		6.5.4　通过Python访问Lealone	183
		6.5.5　Lealone特有的建表语法	184
	6.6　本章小结	185
第7章　构建音乐站用户属性库	187
	7.1　案例背景	187
		7.1.1　音乐站	187
		7.1.2　需求概述	189
		7.1.3　需求范围和系统边界	189
		7.1.4　需求详述	190
		7.1.5　名词解释	194
	7.2　概要设计	195
		7.2.1　设计目标	195
		7.2.2　数据规模假设	195
		7.2.3　功能指标	196
		7.2.4　系统流程	196
	7.3　表结构设计	197
		7.3.1　功能抽象	197
		7.3.2　逻辑结构	198
		7.3.3　Rowkey设计	202
		7.3.4　列族设计	202
		7.3.5　版本定义	202
		7.3.6　优化属性定义	202
	7.4　数据加载	203
		7.4.1　加载流程	203
		7.4.2　Mapper类	204
		7.4.3　Main类	206
		7.4.4　运行	207
	7.5　数据检索	207
		7.5.1　HBaseTable	207
		7.5.2　HBaseAdmin	207
		7.5.3　几种检索类型	209
	7.6　后台查询	212
		7.6.1　二级索引实现	212
		7.6.2　后台查询系统	219
	7.7　本章小结	220
第8章　构建广告实时计算系统	222
	8.1　理解广告数据和流处理框架	222
		8.1.1　网络广告的几大特性	223
		8.1.2　网络广告的数据类型	224
		8.1.3　流处理框架	225
		8.1.4　背景与需求描述	231
	8.2　概要设计	232
		8.2.1　设计目标	233
		8.2.2　主要功能	233
		8.2.3　系统架构	233
	8.3　详细设计	235
		8.3.1　表结构设计	235
		8.3.2　功能模块设计	236
	8.4　核心功能实现	237
		8.4.1　规划集群环境部署	237
		8.4.2　安装ZooKeeper集群	239
		8.4.3　安装Kafka分布式集群	242
		8.4.4　实现Kafka生产者	245
		8.4.5　安装Storm分布式集群	247
		8.4.6　查看集群节点部署情况	254
		8.4.7　基于Storm-kafka中间件实现计算逻辑	254
		8.4.8　如何使用HBase中统计数据	265
	8.5　本章小结	266
第三部分　高级篇	267
第9章　核心概念	268
	9.1　核心结构	268
		9.1.1　B+树	269
		9.1.2　LSM树	269
		9.1.3　两种结构本质区别	271
	9.2　底层持久化	272
		9.2.1　存储基本架构	272
		9.2.2　HDFS文件	273
		9.2.3　Region切分	278
		9.2.4　合并	279
		9.2.5　HFile格式	280
		9.2.6　KeyValue格式	283
	9.3　预写日志	284
		9.3.1　概要流程	284
		9.3.2　相关Java类	285
		9.3.3　日志回放	288
		9.3.4　日志一致性	289
	9.4　写入流程	290
		9.4.1　客户端	290
		9.4.2　服务器端	295
	9.5　查询流程	300
		9.5.1　两种查询操作	300
		9.5.2　客户端	300
		9.5.3　服务器端	301
	9.6　数据备份	305
		9.6.1　备份机制架构	306
		9.6.2　故障恢复	306
	9.7　数据压缩	308
		9.7.1　支持的压缩算法	309
		9.7.2　使用配置	309
	9.8　本章小结	310
第10章　HBase高级特性	311
	10.1　过滤器	311
		10.1.1　过滤器的两类参数	311
		10.1.2　比较器	312
		10.1.3　列值过滤器	314
		10.1.4　键值元数据过滤器	314
		10.1.5　行键过滤器	317
		10.1.6　功能过滤器	317
		10.1.7　Thrift使用过滤器	318
		10.1.8　过滤器总结	323
	10.2　计数器	324
		10.2.1　使用Shell操作计数器	324
		10.2.2　基于单列的计数器	326
		10.2.3　多列计数器	327
	10.3　协处理器	328
		10.3.1　认识协处理器	329
		10.3.2　观察者Observer	330
		10.3.3　终端EndPoint	332
		10.3.4　协处理器部署	334
	10.4　Schema设计要点	337
		10.4.1　行键设计	337
		10.4.2　列族设计	339
	10.5　二级索引	339
		10.5.1　Client-managed方式	340
		10.5.2　ITHBase实现	340
		10.5.3　IHBase实现	343
		10.5.4　Coprocessor方式	343
		10.5.5　MapReduce两种方式	344
	10.6　布隆过滤器	344
		10.6.1　基本概念	345
		10.6.2　配置布隆过滤器	346
		10.6.3　使用布隆过滤器	347
	10.7　负载均衡	347
		10.7.1　全局计划	348
		10.7.2　随机分配计划	351
		10.7.3　批量启动分配计划	351
		10.7.4　通过Shell控制负载均衡	352
	10.8　批量加载	352
		10.8.1　准备数据：importtsv	352
		10.8.2　加载数据：completebulkload	354
	10.9　本章小结	354
第11章　集群运维管理	355
	11.1　HBase常用工具	355
		11.1.1　文件检测修复工具hbck	356
		11.1.2　文件查看工具hfile	360
		11.1.3　WAL日志查看工具hlog	362
		11.1.4　压缩测试工具CompressionTest	363
		11.1.5　数据迁移工具CopyTable	364
		11.1.6　导出工具export	365
		11.1.7　导入工具Import	365
		11.1.8　日志回放工具WALPlayer	365
		11.1.9　行数统计工具RowCounter	366
	11.2　Region和RegionServer管理	367
		11.2.1　大合并工具major_compact	367
		11.2.2　Region合并工具Merge	368
		11.2.3　下线节点	368
		11.2.4　滚动重启	369
	11.3　性能指标Metrics	370
		11.3.1　Master Metrics	371
		11.3.2　RegionServer Metrics	371
		11.3.3　RPC Metrics	372
		11.3.4　JVM Metrics	373
		11.3.5　集群属性Metrics	374
	11.4　监控系统Ganglia	374
		11.4.1　HBase监控指标	374
		11.4.2　安装、部署和使用Ganglia	375
	11.5　HBase管理扩展JMX	380
		11.5.1　如何使用JMX	380
		11.5.2　基于JMX的监控工具Ella	382
	11.6　报警工具Nagios	385
	11.7　故障处理	390
		11.7.1　问题咨询渠道	391
		11.7.2　常用日志信息	391
		11.7.3　常用故障调试工具	393
		11.7.4　客户端故障排查	398
		11.7.5　MapReduce故障排查	400
		11.7.6　网络故障排查	401
		11.7.7　RegionServer相关问题解决	401
		11.7.8　Master相关问题解决	405
		11.7.9　ZooKeeper相关问题解决	406
	11.8　集群备份	406
		11.8.1　冷备份	407
		11.8.2　热备份之Replication	407
		11.8.3　热备份之CopyTable	407
		11.8.4　热备份之Export	407
	11.9　本章小结	407
第12章　性能调优	409
	12.1　硬件和操作系统调优	409
		12.1.1　配置内存	409
		12.1.2　配置CPU	410
		12.1.3　操作系统	410
	12.2　网络通信调优	413
		12.2.1　配置交换机	413
		12.2.2　添加机架感知	415
	12.3　JVM优化	416
		12.3.1　Java垃圾回收算法	416
		12.3.2　Java垃圾收集器	417
		12.3.3　垃圾回收器的选择	419
		12.3.4　JVM参数设置	420
	12.4　HBase查询优化	422
		12.4.1　设置Scan缓存	422
		12.4.2　显式地指定列	423
		12.4.3　关闭ResultScanner	424
		12.4.4　禁用块缓存	424
		12.4.5　优化行键查询	424
		12.4.6　通过HTableTool访问	424
		12.4.7　使用批量读	425
		12.4.8　使用Filter降低客户端压力	426
		12.4.9　使用Coprocessor统计行数	426
		12.4.10　缓存查询结果	427
	12.5　HBase写入优化	427
		12.5.1　关闭写WAL日志	427
		12.5.2　设置AutoFlush	428
		12.5.3　预创建Region	429
		12.5.4　延迟日志flush	433
		12.5.5　通过HTableTool访问	433
		12.5.6　使用批量写	434
	12.6　HBase基本核心服务优化	435
		12.6.1　优化分裂操作	435
		12.6.2　优化合并操作	437
	12.7　HBase配置参数优化	437
		12.7.1　设置RegionServer Handler数量	437
		12.7.2　调整BlockCache大小	439
		12.7.3　设置MemStore的上下限	440
		12.7.4　调整影响合并的文件数	441
		12.7.5　调整MemStore的flush因子	441
		12.7.6　调整单个文件大小	441
		12.7.7　调整ZooKeeper Session的有效时长	442
	12.8　分布式协调系统ZooKeeper优化	442
		12.8.1　配置ZooKeeper节点数	442
		12.8.2　独立ZooKeeper集群	443
	12.9　表设计优化	444
		12.9.1　开启布隆过滤器	444
		12.9.2　调整列族块大小	444
		12.9.3　设置In Memory属性	446
		12.9.4　调整列族最大版本数	448
		12.9.5　设置TTL属性	449
	12.10　其他优化	450
		12.10.1　关闭MapReduce的预测执行功能	450
		12.10.2　修改负载均衡执行周期	452
	12.11　性能测试	452
	12.12　本章小结	455
附录A　HBase配置参数介绍	456
附录B　Phoenix SQL语法详解	465
附录C　YCSB编译安装	482
